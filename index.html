<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenDeSci - Community Hub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Navigation */
    .nav {
      background: #2c3e50;
      color: white;
      padding: 15px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .nav .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    #menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    .sidebar {
      display: block;
    }
    
    .sidebar ul {
      display: flex;
      list-style: none;
    }
    
    .sidebar li {
      margin: 0 15px;
    }
    
    .sidebar a {
      color: white;
      text-decoration: none;
      transition: color 0.3s;
      font-weight: 500;
    }
    
    .sidebar a:hover {
      color: #3498db;
    }
    
    .voice-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s;
    }
    
    .voice-btn:hover {
      background: #c0392b;
    }
    
    /* Hero Section */
    .hero {
      text-align: center;
      padding: 60px 20px;
      background: white;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .hero h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .hero p {
      font-size: 1.2rem;
      margin-bottom: 30px;
      color: #7f8c8d;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
      font-weight: 600;
    }
    
    .btn:hover {
      background: #2980b9;
    }
    
    /* Cards */
    .card {
      background: white;
      padding: 30px;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .card h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }
    
    /* Video Container */
    .video-container {
      width: 100%;
      height: 500px;
      background: #1a1a1a;
      border-radius: 8px;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    
    /* Video Grid */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 10px;
      width: 100%;
      height: 100%;
      padding: 10px;
    }
    
    .video-item {
      background: #2c3e50;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .video-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-item .name-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      font-size: 12px;
    }
    
    /* Audio Mode */
    .audio-mode {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    
    .participant-card {
      background: #34495e;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      color: white;
    }
    
    .participant-card .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 10px;
      background: #3498db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .participant-card.host {
      background: #e74c3c;
    }
    
    .participant-card.speaker {
      background: #f39c12;
    }
    
    /* Promo Video */
    .promo-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .promo-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    
    /* Live Banner */
    .live-banner {
      background: #e74c3c;
      color: white;
      padding: 12px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 5px;
      display: none;
      font-weight: bold;
    }
    
    /* Buttons */
    .join-live-btn {
      display: inline-block;
      padding: 12px 25px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin: 10px 0;
      transition: background 0.3s;
      font-weight: 600;
    }
    
    .join-live-btn:hover {
      background: #c0392b;
    }
    
    /* Admin Button */
    .admin-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: background 0.3s, transform 0.3s;
    }
    
    .admin-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
    }
    
    .modal-content h3 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .modal-content input, .modal-content textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    
    .modal-content textarea {
      height: 100px;
      resize: vertical;
    }
    
    .modal-content button {
      margin: 5px;
      padding: 10px 20px;
    }
    
    /* Admin Panel */
    .admin-panel {
      display: none;
      margin: 20px;
      padding: 25px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .admin-panel h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }
    
    .admin-panel button {
      margin: 5px;
      padding: 10px 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .admin-panel button:hover {
      background: #2980b9;
    }
    
    /* Participant and Mic Request Lists */
    .list-container {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .list-container h4 {
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .participant-item, .mic-request-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .participant-item:last-child, .mic-request-item:last-child {
      border-bottom: none;
    }
    
    .participant-item button, .mic-request-item button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
      color: white;
    }
    
    .btn-approve {
      background: #2ecc71;
    }
    
    .btn-reject {
      background: #e74c3c;
    }
    
    .btn-mute {
      background: #f39c12;
    }
    
    .btn-remove {
      background: #e74c3c;
    }
    
    /* Events */
    .events-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .event-card {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }
    
    .event-card:hover {
      transform: translateY(-5px);
    }
    
    .event-card h3 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .event-card p {
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .event-card .event-date {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .countdown {
      font-size: 1.2rem;
      font-weight: bold;
      color: #2c3e50;
      margin-top: 10px;
    }
    
    /* Mode Selector */
    .mode-selector {
      display: flex;
      gap: 15px;
      margin: 20px 0;
    }
    
    .mode-btn {
      padding: 10px 20px;
      background: #ddd;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .mode-btn.active {
      background: #3498db;
      color: white;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .nav .container {
        flex-direction: column;
      }
      
      #menu-btn {
        display: block;
      }
      
      .sidebar {
        display: none;
        width: 100%;
      }
      
      .sidebar.active {
        display: block;
      }
      
      .sidebar ul {
        flex-direction: column;
        margin-top: 20px;
      }
      
      .sidebar li {
        margin: 10px 0;
      }
      
      .video-container {
        height: 300px;
      }
      
      .video-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
      }
      
      .hero h1 {
        font-size: 2rem;
      }
      
      .events-container {
        grid-template-columns: 1fr;
      }
      
      .admin-panel {
        margin: 10px;
        padding: 15px;
      }
      
      .audio-mode {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
    
    /* Animations */
    .fade-in {
      animation: fadeIn 1s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Loading Spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Status Indicators */
    .status-online {
      width: 10px;
      height: 10px;
      background: #2ecc71;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    
    .status-offline {
      width: 10px;
      height: 10px;
      background: #e74c3c;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <main id="app">
    <header class="nav" role="navigation" aria-label="Main navigation">
      <div class="container">
        <div class="logo">OpenDeSci
          <button id="menu-btn" aria-label="Toggle menu">☰</button>
        </div>
        <nav id="sidebar" class="sidebar">
          <ul>
            <li><a href="#/home" aria-label="Home page">Home</a></li>
            <li><a href="#/learn" aria-label="Learn about DeSci">Learn</a></li>
            <li><a href="#/contribute" aria-label="Contribute to DeSci">Contribute</a></li>
            <li><a href="#/fund-build" aria-label="Fund and Build DeSci">Fund & Build</a></li>
            <li><a href="#/community" aria-label="Join DeSci Community">Community</a></li>
            <li><a href="#/future" aria-label="Explore the Future of DeSci">Future</a></li>
            <li><a href="#/explore" aria-label="Explore DeSci Projects">Project Explorer</a></li>
          </ul>
        </nav>
        <div>
          <button onclick="startVoice()" class="voice-btn" aria-label="Start voice navigation">🎙️</button>
        </div>
      </div>
    </header>

    <section class="hero fade-in" role="banner">
      <h1>Join the DeSci Community</h1>
      <p>Connect with researchers, developers, and enthusiasts to collaborate on DeSci.</p>
      <button class="btn" onclick="location.hash='/community'" aria-label="Join the community">Join Now</button>
      
      <!-- Video/Audio Container -->
      <div class="video-container" id="video-container">
        <div class="video-grid" id="video-grid"></div>
        <div class="audio-mode" id="audio-mode" style="display: none;"></div>
        <video class="promo-video" id="promo-video" controls style="display: none;">
          <source src="https://assets.codepen.io/3364143/sample.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <div class="promo-controls" id="promo-controls" style="display: none;">
          <button class="btn" onclick="togglePromoVideo()">Pause Promo</button>
        </div>
      </div>
      
      <!-- Mode Selector -->
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('video')">Video Mode</button>
        <button class="mode-btn" onclick="setMode('audio')">Audio Mode</button>
      </div>
      
      <div id="live-banner" class="live-banner">🔴 Live Now on <span id="live-platform"></span></div>
      <button class="join-live-btn" id="join-live-btn">Join Live</button>
    </section>

    <section class="card fade-in" id="leaderboard" aria-labelledby="leaderboard-heading">
      <h2 id="leaderboard-heading">Community Leaderboard</h2>
      <p>Meet our top contributors driving DeSci forward.</p>
      <div class="profile-grid">
        <!-- Dynamic leaderboard loaded here -->
        <div class="event-card">
          <h3>Top Contributor: Dr. Jane Smith</h3>
          <p>Published 12 research papers on decentralized science</p>
        </div>
        <div class="event-card">
          <h3>Innovator: Alex Johnson</h3>
          <p>Developed novel data sharing protocol</p>
        </div>
      </div>
    </section>

    <section class="card fade-in live-streaming" aria-labelledby="live-streaming-heading">
      <h2 id="live-streaming-heading">Live Events</h2>
      <div id="live-container"></div>
    </section>

    <section class="card fade-in hosted-calls" aria-labelledby="hosted-calls-heading">
      <h2 id="hosted-calls-heading">Hosted Calls</h2>
      <div id="hosted-call-container" class="events-container">
        <div class="event-card">
          <h3>Weekly DeSci Discussion</h3>
          <p class="event-date">Every Thursday, 5 PM UTC</p>
          <p>Join our weekly community call to discuss DeSci developments</p>
        </div>
      </div>
    </section>

    <section class="card fade-in upcoming-events" aria-labelledby="upcoming-events-heading">
      <h2 id="upcoming-events-heading">Upcoming Events</h2>
      <div id="upcoming-events-container" class="events-container">
        <div class="event-card">
          <h3>DeSci Conference 2023</h3>
          <p class="event-date">December 15, 2023 | 10:00 AM UTC</p>
          <p>Annual conference on decentralized science innovations</p>
          <div class="countdown" id="countdown-1"></div>
        </div>
      </div>
    </section>

    <section class="card fade-in past-events" aria-labelledby="past-events-heading">
      <h2 id="past-events-heading">Past Events</h2>
      <div id="past-events-container" class="events-container">
        <div class="event-card">
          <h3>Intro to DeSci Workshop</h3>
          <p class="event-date">October 5, 2023</p>
          <p>Recording available for members</p>
        </div>
      </div>
    </section>

    <div class="admin-panel" id="admin-panel">
      <h2>Admin Panel</h2>
      <button onclick="scheduleLive()">Schedule Live</button>
      <button onclick="startLive()" id="start-live-btn">Start Live</button>
      <button onclick="endLive()" id="end-live-btn">End Live</button>
      <button onclick="muteAll()">Mute All</button>
      <button onclick="togglePromoVideo()" id="promo-toggle-btn">Pause Promo</button>
      
      <div class="list-container">
        <h4>Microphone Requests</h4>
        <div id="mic-requests"></div>
      </div>
      
      <div class="list-container">
        <h4>Participants</h4>
        <div id="participants"></div>
      </div>
      
      <button onclick="logoutAdmin()">Logout</button>
    </div>
    
    <div class="modal" id="password-modal">
      <div class="modal-content">
        <h3>Admin Login</h3>
        <input type="password" id="admin-password" placeholder="Enter password">
        <button onclick="loginAdmin()">Login</button>
        <button onclick="closeModal('password-modal')">Cancel</button>
      </div>
    </div>
    
    <div class="modal" id="schedule-modal">
      <div class="modal-content">
        <h3>Schedule Live Event</h3>
        <input type="text" id="event-title" placeholder="Title">
        <input type="datetime-local" id="event-time">
        <select id="event-type">
          <option value="video">Video Mode</option>
          <option value="audio">Audio Mode</option>
        </select>
        <textarea id="event-description" placeholder="Description"></textarea>
        <button onclick="saveEvent()">Save</button>
        <button onclick="closeModal('schedule-modal')">Cancel</button>
      </div>
    </div>
  </main>
  
  <button class="admin-btn" id="admin-btn">👤</button>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Jitsi Meet API -->
  <script src="https://meet.jit.si/external_api.js"></script>
  
  <script>
    // ===== COMMUNITY HUB IMPLEMENTATION =====

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCie4lyWxHhnfaRZnKZI4crWHQQ18EjVVo",
      authDomain: "opendesci-community.firebaseapp.com",
      projectId: "opendesci-community",
      storageBucket: "opendesci-community.firebasestorage.app",
      messagingSenderId: "175060392409",
      appId: "1:175060392409:web:d86e37965cefc1961f21c8",
      measurementId: "G-NPY0HT1R1N"
    };

    // Initialize Firebase
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
    }

    // Global variables for Community Hub
    let api = null;
    let isAdmin = false;
    let participants = [];
    let micRequests = [];
    let isLive = false;
    let currentMode = 'video';
    let promoPlaying = false;
    let eventsData = [];

    // Initialize Community Hub
    function initializeCommunityHub() {
      // Set up admin button
      const adminBtn = document.getElementById('admin-btn');
      if (adminBtn) {
        adminBtn.addEventListener('click', openPasswordModal);
      }
      
      // Set up join live button
      const joinLiveBtn = document.getElementById('join-live-btn');
      if (joinLiveBtn) {
        joinLiveBtn.style.display = 'none';
        joinLiveBtn.addEventListener('click', joinLiveMeeting);
      }
      
      // Set up live banner
      const liveBanner = document.getElementById('live-banner');
      if (liveBanner) {
        liveBanner.style.display = 'none';
      }
      
      // Set default video placeholder
      setDefaultVideoPlaceholder();
      
      // Load events
      loadEvents();
      
      // Check if user is already logged in
      if (typeof firebase !== 'undefined') {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            isAdmin = true;
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel) adminPanel.style.display = 'block';
          }
        });
      }
      
      // Set up mode buttons
      const videoModeBtn = document.querySelector('.mode-btn[onclick="setMode(\'video\')"]');
      const audioModeBtn = document.querySelector('.mode-btn[onclick="setMode(\'audio\')"]');
      
      if (videoModeBtn && audioModeBtn) {
        videoModeBtn.classList.add('active');
        audioModeBtn.classList.remove('active');
      }
      
      // Start promo video
      playPromoVideo();
    }

    // Set video/audio mode
    function setMode(mode) {
      currentMode = mode;
      
      const videoModeBtn = document.querySelector('.mode-btn[onclick="setMode(\'video\')"]');
      const audioModeBtn = document.querySelector('.mode-btn[onclick="setMode(\'audio\')"]');
      const videoGrid = document.getElementById('video-grid');
      const audioMode = document.getElementById('audio-mode');
      
      if (videoModeBtn && audioModeBtn) {
        if (mode === 'video') {
          videoModeBtn.classList.add('active');
          audioModeBtn.classList.remove('active');
          if (videoGrid) videoGrid.style.display = 'grid';
          if (audioMode) audioMode.style.display = 'none';
        } else {
          videoModeBtn.classList.remove('active');
          audioModeBtn.classList.add('active');
          if (videoGrid) videoGrid.style.display = 'none';
          if (audioMode) audioMode.style.display = 'grid';
        }
      }
      
      // If live, restart with new mode
      if (isLive && api) {
        endLive();
        setTimeout(startLive, 1000);
      }
    }

    // Play promo video
    function playPromoVideo() {
      const promoVideo = document.getElementById('promo-video');
      const promoControls = document.getElementById('promo-controls');
      
      if (promoVideo && promoControls) {
        promoVideo.style.display = 'block';
        promoControls.style.display = 'flex';
        promoVideo.play().catch(e => console.error('Promo video play error:', e));
        promoPlaying = true;
      }
    }

    // Pause/play promo video
    function togglePromoVideo() {
      const promoVideo = document.getElementById('promo-video');
      const promoBtn = document.getElementById('promo-toggle-btn');
      
      if (promoVideo) {
        if (promoPlaying) {
          promoVideo.pause();
          if (promoBtn) promoBtn.textContent = 'Play Promo';
          promoPlaying = false;
        } else {
          promoVideo.play();
          if (promoBtn) promoBtn.textContent = 'Pause Promo';
          promoPlaying = true;
        }
      }


          // Password modal functions
    function openPasswordModal() {
      const passwordModal = document.getElementById('password-modal');
      const adminPasswordInput = document.getElementById('admin-password');
      
      if (passwordModal && adminPasswordInput) {
        passwordModal.style.display = 'flex';
        adminPasswordInput.value = '';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    }

    async function loginAdmin() {
      const adminPasswordInput = document.getElementById('admin-password');
      if (!adminPasswordInput) return;
      
      const password = adminPasswordInput.value;
      const email = "admin@opendesci.com"; // You'll need to create this user in Firebase Auth
      
      try {
        if (typeof firebase === 'undefined') {
          throw new Error('Firebase not loaded. Please check your internet connection.');
        }
        
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        
        isAdmin = true;
        const adminPanel = document.getElementById('admin-panel');
        if (adminPanel) adminPanel.style.display = 'block';
        
        const passwordModal = document.getElementById('password-modal');
        if (passwordModal) passwordModal.style.display = 'none';
        
        // Store admin session
        localStorage.setItem('adminSession', 'true');
        
      } catch (error) {
        alert('Login failed: ' + error.message);
      }
    }

    function logoutAdmin() {
      if (typeof firebase !== 'undefined') {
        firebase.auth().signOut().then(() => {
          isAdmin = false;
          const adminPanel = document.getElementById('admin-panel');
          if (adminPanel) adminPanel.style.display = 'none';
          localStorage.removeItem('adminSession');
        }).catch((error) => {
          console.error('Logout error:', error);
        });
      }
    }

    // Video placeholder functions
    function setDefaultVideoPlaceholder() {
      const videoContainer = document.getElementById('video-container');
      if (videoContainer) {
        videoContainer.innerHTML = `
          <div class="video-grid" id="video-grid"></div>
          <div class="audio-mode" id="audio-mode" style="display: none;"></div>
          <video class="promo-video" id="promo-video" controls>
            <source src="https://assets.codepen.io/3364143/sample.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="promo-controls" id="promo-controls">
            <button class="btn" onclick="togglePromoVideo()">Pause Promo</button>
          </div>
        `;
        
        // Initialize promo video
        playPromoVideo();
      }
    }

    function setLiveVideoPlaceholder() {
      const videoContainer = document.getElementById('video-container');
      if (videoContainer) {
        videoContainer.innerHTML = `
          <div class="video-grid" id="video-grid"></div>
          <div class="audio-mode" id="audio-mode" style="display: none;"></div>
        `;
        
        // Set mode
        setMode(currentMode);
      }
    }

    // Jitsi Meet functions
    function startLive() {
      const roomName = 'OpenDeSci-' + Date.now();
      isLive = true;
      
      // UI updates
      const startLiveBtn = document.getElementById('start-live-btn');
      const endLiveBtn = document.getElementById('end-live-btn');
      const liveBanner = document.getElementById('live-banner');
      const joinLiveBtn = document.getElementById('join-live-btn');
      
      if (startLiveBtn) startLiveBtn.style.display = 'none';
      if (endLiveBtn) endLiveBtn.style.display = 'inline-block';
      if (liveBanner) {
        liveBanner.style.display = 'block';
        const livePlatform = document.getElementById('live-platform');
        if (livePlatform) livePlatform.textContent = 'Jitsi Meet';
      }
      if (joinLiveBtn) {
        joinLiveBtn.style.display = 'inline-block';
        joinLiveBtn.textContent = 'Join Live Session';
      }
      
      // Set up live video placeholder
      setLiveVideoPlaceholder();
      
      // Stop promo video
      const promoVideo = document.getElementById('promo-video');
      if (promoVideo) {
        promoVideo.pause();
        promoPlaying = false;
      }
      
      // Initialize Jitsi Meet
      const domain = 'meet.jit.si';
      const options = {
        roomName: roomName,
        width: '100%',
        height: '100%',
        parentNode: document.getElementById('video-container'),
        configOverwrite: {
          startWithAudioMuted: true,
          startWithVideoMuted: currentMode === 'audio',
          enableWelcomePage: false,
          prejoinPageEnabled: false,
          disableDeepLinking: true,
          enableNoisyMicDetection: false,
          requireDisplayName: true,
          enableClosePage: false
        },
        interfaceConfigOverwrite: {
          TOOLBAR_BUTTONS: [
            'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
            'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
            'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
            'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
            'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
            'security'
          ],
          SHOW_JITSI_WATERMARK: false,
          SHOW_WATERMARK_FOR_GUESTS: false,
          SHOW_BRAND_WATERMARK: false,
          DISABLE_VIDEO_BACKGROUND: false,
          DISABLE_FOCUS_INDICATOR: false
        },
        userInfo: {
          displayName: 'Host',
          email: ''
        }
      };
      
      // Load Jitsi API if not already loaded
      if (typeof JitsiMeetExternalAPI === 'undefined') {
        console.error('Jitsi Meet API not loaded');
        showToast('Error: Jitsi Meet API not loaded. Please check your internet connection.');
        return;
      }
      
      api = new JitsiMeetExternalAPI(domain, options);
      
      // Set up event listeners
      api.addEventListener('participantJoined', handleParticipantJoined);
      api.addEventListener('participantLeft', handleParticipantLeft);
      api.addEventListener('raiseHandUpdated', handleRaiseHandUpdated);
      api.addEventListener('videoConferenceJoined', handleConferenceJoined);
      api.addEventListener('videoConferenceLeft', handleConferenceLeft);
    }

    function joinLiveMeeting() {
      if (api) {
        // Instead of opening a new tab, focus on the current meeting
        showToast('You are already in the meeting');
      } else {
        showToast('No live meeting is currently active');
      }
    }

    function endLive() {
      if (api) {
        api.dispose();
        api = null;
      }
      
      isLive = false;
      
      // Reset UI
      const startLiveBtn = document.getElementById('start-live-btn');
      const endLiveBtn = document.getElementById('end-live-btn');
      const liveBanner = document.getElementById('live-banner');
      const joinLiveBtn = document.getElementById('join-live-btn');
      
      if (startLiveBtn) startLiveBtn.style.display = 'inline-block';
      if (endLiveBtn) endLiveBtn.style.display = 'none';
      if (liveBanner) liveBanner.style.display = 'none';
      if (joinLiveBtn) joinLiveBtn.style.display = 'none';
      
      participants = [];
      micRequests = [];
      updateParticipantsList();
      updateMicRequestsList();
      
      // Return to default video
      setDefaultVideoPlaceholder();
    }

    // Participant management
    function handleParticipantJoined(event) {
      const participant = {
        id: event.id,
        displayName: event.displayName || 'Participant',
        role: 'listener'
      };
      
      // Check if participant already exists
      if (!participants.find(p => p.id === participant.id)) {
        participants.push(participant);
        updateParticipantsList();
        renderVideoGrid();
        renderAudioMode();
      }
    }

    function handleParticipantLeft(event) {
      participants = participants.filter(p => p.id !== event.id);
      updateParticipantsList();
      renderVideoGrid();
      renderAudioMode();
      
      // Remove any mic requests from this participant
      micRequests = micRequests.filter(r => r.participantId !== event.id);
      updateMicRequestsList();
    }

    function handleRaiseHandUpdated(event) {
      if (event.raisedHand) {
        // Add to mic requests if not already there
        const participant = participants.find(p => p.id === event.participantId);
        if (participant && !micRequests.find(r => r.participantId === event.participantId)) {
          micRequests.push({
            participantId: event.participantId,
            displayName: participant.displayName
          });
          updateMicRequestsList();
        }
      } else {
        // Remove from mic requests
        micRequests = micRequests.filter(r => r.participantId !== event.participantId);
        updateMicRequestsList();
      }
    }

    function handleConferenceJoined(event) {
      console.log('Conference joined successfully');
    }

    function handleConferenceLeft(event) {
      if (event.reason === 'clicked hangup') {
        endLive();
      }
    }

    // Render video grid
    function renderVideoGrid() {
      const videoGrid = document.getElementById('video-grid');
      if (!videoGrid) return;
      
      videoGrid.innerHTML = '';
      
      // Add host first
      const host = { id: 'host', displayName: 'Host', role: 'host' };
      
      // Add all participants
      const allParticipants = [host, ...participants];
      
      // Limit to 16 participants for 4x4 grid
      const participantsToShow = allParticipants.slice(0, 16);
      
      participantsToShow.forEach(participant => {
        const videoItem = document.createElement('div');
        videoItem.className = 'video-item';
        videoItem.innerHTML = `
          <div style="width:100%; height:100%; background:#3498db; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
            ${participant.displayName.charAt(0)}
          </div>
          <div class="name-overlay">${participant.displayName}</div>
        `;
        videoGrid.appendChild(videoItem);
      });
          }

      // Render audio mode
    function renderAudioMode() {
      const audioMode = document.getElementById('audio-mode');
      if (!audioMode) return;
      
      audioMode.innerHTML = '';
      
      // Add host
      const hostCard = document.createElement('div');
      hostCard.className = 'participant-card host';
      hostCard.innerHTML = `
        <div class="avatar">H</div>
        <h4>Host</h4>
        <p>Host</p>
      `;
      audioMode.appendChild(hostCard);
      
      // Add speakers
      participants.filter(p => p.role === 'speaker').forEach(participant => {
        const speakerCard = document.createElement('div');
        speakerCard.className = 'participant-card speaker';
        speakerCard.innerHTML = `
          <div class="avatar">${participant.displayName.charAt(0)}</div>
          <h4>${participant.displayName}</h4>
          <p>Speaker</p>
        `;
        audioMode.appendChild(speakerCard);
      });
      
      // Add listeners
      participants.filter(p => p.role === 'listener').forEach(participant => {
        const listenerCard = document.createElement('div');
        listenerCard.className = 'participant-card';
        listenerCard.innerHTML = `
          <div class="avatar">${participant.displayName.charAt(0)}</div>
          <h4>${participant.displayName}</h4>
          <p>Listener</p>
        `;
        audioMode.appendChild(listenerCard);
      });
    }

    function updateParticipantsList() {
      const participantsContainer = document.getElementById('participants');
      if (!participantsContainer) return;
      
      participantsContainer.innerHTML = '';
      
      if (participants.length === 0) {
        participantsContainer.innerHTML = '<p>No participants</p>';
        return;
      }
      
      participants.forEach(participant => {
        const participantEl = document.createElement('div');
        participantEl.className = 'participant-item';
        participantEl.innerHTML = `
          <span>${participant.displayName} (${participant.role})</span>
          <div>
            <button class="btn-mute" onclick="muteParticipant('${participant.id}')">Mute</button>
            <button class="btn-remove" onclick="kickParticipant('${participant.id}')">Remove</button>
            ${participant.role === 'listener' ? 
              `<button class="btn-approve" onclick="promoteToSpeaker('${participant.id}')">Promote</button>` : 
              `<button class="btn-reject" onclick="demoteToListener('${participant.id}')">Demote</button>`
            }
          </div>
        `;
        participantsContainer.appendChild(participantEl);
      });
    }

    function updateMicRequestsList() {
      const micRequestsContainer = document.getElementById('mic-requests');
      if (!micRequestsContainer) return;
      
      micRequestsContainer.innerHTML = '';
      
      if (micRequests.length === 0) {
        micRequestsContainer.innerHTML = '<p>No mic requests</p>';
        return;
      }
      
      micRequests.forEach(request => {
        const requestEl = document.createElement('div');
        requestEl.className = 'mic-request-item';
        requestEl.innerHTML = `
          <span>${request.displayName} wants to speak</span>
          <div>
            <button class="btn-approve" onclick="approveMicRequest('${request.participantId}')">Approve</button>
            <button class="btn-reject" onclick="rejectMicRequest('${request.participantId}')">Reject</button>
          </div>
        `;
        micRequestsContainer.appendChild(requestEl);
      });
    }

    // Admin control functions
    function muteAll() {
      if (!api) return;
      
      participants.forEach(participant => {
        api.executeCommand('muteParticipant', participant.id);
      });
    }

    function muteParticipant(participantId) {
      if (!api) return;
      api.executeCommand('muteParticipant', participantId);
    }

    function kickParticipant(participantId) {
      if (!api) return;
      api.executeCommand('kickParticipant', participantId);
    }

    function promoteToSpeaker(participantId) {
      const participant = participants.find(p => p.id === participantId);
      if (participant) {
        participant.role = 'speaker';
        updateParticipantsList();
        renderAudioMode();
      }
    }

    function demoteToListener(participantId) {
      const participant = participants.find(p => p.id === participantId);
      if (participant) {
        participant.role = 'listener';
        updateParticipantsList();
        renderAudioMode();
      }
    }

    function approveMicRequest(participantId) {
      if (!api) return;
      
      // Unmute the participant
      api.executeCommand('muteParticipant', participantId, false);
      
      // Promote to speaker
      promoteToSpeaker(participantId);
      
      // Remove from mic requests
      micRequests = micRequests.filter(r => r.participantId !== participantId);
      updateMicRequestsList();
    }

    function rejectMicRequest(participantId) {
      // Just remove from mic requests
      micRequests = micRequests.filter(r => r.participantId !== participantId);
      updateMicRequestsList();
    }

    // Schedule functions
    function scheduleLive() {
      document.getElementById('schedule-modal').style.display = 'flex';
    }

    async function saveEvent() {
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      const typeInput = document.getElementById('event-type');
      const descriptionInput = document.getElementById('event-description');
      
      if (!titleInput || !timeInput || !typeInput) return;
      
      const title = titleInput.value;
      const time = timeInput.value;
      const type = typeInput.value;
      const description = descriptionInput ? descriptionInput.value : '';
      
      if (!title || !time) {
        alert('Please fill in title and time');
        return;
      }

      try {
        // Create event object
        const event = {
          title,
          time,
          type,
          description,
          createdAt: new Date().toISOString()
        };
        
        // Add to events array
        eventsData.push(event);
        
        // Save to localStorage
        localStorage.setItem('communityEvents', JSON.stringify(eventsData));
        
        // If using Firebase, save to Firestore
        if (typeof firebase !== 'undefined' && isAdmin) {
          await firebase.firestore().collection('events').add({
            title: title,
            time: time,
            type: type,
            description: description,
            createdAt: new Date(),
            createdBy: firebase.auth().currentUser.uid
          });
        }
        
        alert('Event scheduled successfully!');
        closeModal('schedule-modal');
        
        // Clear form
        titleInput.value = '';
        timeInput.value = '';
        if (descriptionInput) descriptionInput.value = '';
        
        // Refresh events list
        loadEvents();
        
      } catch (error) {
        alert('Error saving event: ' + error.message);
        console.error('Save error:', error);
      }
    }

    function loadEvents() {
      try {
        // Load from localStorage
        const storedEvents = localStorage.getItem('communityEvents');
        if (storedEvents) {
          eventsData = JSON.parse(storedEvents);
        }
        
        // If using Firebase, load from Firestore
        if (typeof firebase !== 'undefined') {
          firebase.firestore()
            .collection('events')
            .orderBy('time', 'asc')
            .get()
            .then(eventsSnapshot => {
              eventsSnapshot.forEach(doc => {
                const event = doc.data();
                // Add to eventsData if not already there
                if (!eventsData.find(e => e.title === event.title && e.time === event.time)) {
                  eventsData.push(event);
                }
              });
              
              // Update UI
              renderEvents();
            })
            .catch(error => {
              console.error('Error loading events from Firebase:', error);
              // Still render events from localStorage
              renderEvents();
            });
        } else {
          // Just render events from localStorage
          renderEvents();
        }
        
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    function renderEvents() {
      const upcomingContainer = document.getElementById('upcoming-events-container');
      const pastContainer = document.getElementById('past-events-container');
      
      if (!upcomingContainer || !pastContainer) return;
      
      upcomingContainer.innerHTML = '';
      pastContainer.innerHTML = '';
      
      const now = new Date();
      
      eventsData.forEach(event => {
        const eventDate = new Date(event.time);
        
        const eventHTML = `
          <div class="event-card">
            <h3>${event.title}</h3>
            <p class="event-date">${eventDate.toLocaleString()}</p>
            <p>Type: ${event.type}</p>
            <p>${event.description || 'No description'}</p>
            <div class="countdown" id="countdown-${event.title.replace(/\s+/g, '-')}"></div>
          </div>
        `;
        
        if (eventDate > now) {
          upcomingContainer.innerHTML += eventHTML;
          
          // Set up countdown timer
          setTimeout(() => {
            setupCountdown(event.title.replace(/\s+/g, '-'), eventDate);
          }, 100);
        } else {
          pastContainer.innerHTML += eventHTML;
        }
      });
    }

    function setupCountdown(id, eventDate) {
      const countdownElement = document.getElementById(`countdown-${id}`);
      if (!countdownElement) return;
      
      const countdownInterval = setInterval(() => {
        const now = new Date();
        const distance = eventDate - now;
        
        if (distance < 0) {
          clearInterval(countdownInterval);
          countdownElement.innerHTML = 'Event started!';
          return;
        }
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }, 1000);
    }

    // Enhanced showToast function
    function showToast(message) {
      // Create toast element if it doesn't exist
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = '#333';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '5px';
        toast.style.zIndex = '10000';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        document.body.appendChild(toast);
      }
      
      toast.textContent = message;
      toast.style.opacity = '1';
      
      setTimeout(() => {
        toast.style.opacity = '0';
      }, 3000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Check if on community page
      const route = window.location.hash.replace('#/', '') || 'home';
      if (route === 'community') {
        initializeCommunityHub();
      }
      
      // Check if user was previously logged in
      const adminSession = localStorage.getItem('adminSession');
      if (adminSession === 'true') {
        const adminPanel = document.getElementById('admin-panel');
        if (adminPanel) adminPanel.style.display = 'block';
        isAdmin = true;
      }
    });
  </script>
</body>
</html>
  
    
