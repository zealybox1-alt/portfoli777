<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenDeSci - Community Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== CSS STYLES ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .nav {
      background: #2c3e50; color: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 100;
    }
    .nav .container { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; }
    .sidebar ul { display: flex; list-style: none; }
    .sidebar li { margin: 0 15px; }
    .sidebar a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
    .sidebar a:hover { color: #3498db; }
    .voice-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px;
      cursor: pointer; font-size: 18px; transition: background 0.3s; }
    .voice-btn:hover { background: #c0392b; }
    .hero { text-align: center; padding: 60px 20px; background: white; margin: 20px; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .hero h1 { font-size: 2.5rem; margin-bottom: 20px; color: #2c3e50; }
    .hero p { font-size: 1.2rem; margin-bottom: 30px; color: #7f8c8d; max-width: 800px; margin: 0 auto 30px auto; }
    .btn { background: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 5px;
      cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s; }
    .btn:hover { background: #2980b9; }
    .card { background: white; padding: 30px; margin: 20px; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .card h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    .video-container { width: 100%; height: 400px; background: #1a1a1a; border-radius: 8px; margin: 20px 0;
      position: relative; overflow: hidden; }
    .video-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
      gap: 10px; width: 100%; height: 100%; padding: 10px; }
    .video-item { background: #2c3e50; border-radius: 8px; overflow: hidden; position: relative; }
    .video-item .name-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7);
      color: white; padding: 5px; font-size: 12px; }
    .audio-mode { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 20px; }
    .participant-card { background: #34495e; border-radius: 10px; padding: 15px; text-align: center; color: white; }
    .participant-card.host { background: #e74c3c; }
    .participant-card.speaker { background: #f39c12; }
    .promo-video { width: 100%; height: 100%; object-fit: cover; }
    .promo-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; }
    .live-banner { background: #e74c3c; color: white; padding: 12px; text-align: center; margin-bottom: 15px;
      border-radius: 5px; display: none; font-weight: bold; }
    .join-live-btn { display: none; padding: 12px 25px; background: #e74c3c; color: white; border: none;
      border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 10px 0; font-weight: 600; }
    .join-live-btn:hover { background: #c0392b; }
    .admin-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%;
      background: #2c3e50; color: white; border: none; cursor: pointer; font-size: 24px;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000; transition: background 0.3s, transform 0.3s; }
    .admin-btn:hover { background: #3498db; transform: scale(1.1); }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000; }
    .modal-content { background: white; padding: 30px; border-radius: 10px; text-align: center;
      width: 90%; max-width: 400px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
    .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
    .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 12px; margin: 10px 0;
      border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .modal-content textarea { height: 100px; resize: vertical; }
    .modal-content button { margin: 5px; padding: 10px 20px; }
    .admin-panel { display: none; margin: 20px; padding: 25px; border: 1px solid #ddd; background: #f8f9fa;
      border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .admin-panel h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    .admin-panel button { margin: 5px; padding: 10px 15px; background: #3498db; color: white; border: none;
      border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    .admin-panel button:hover { background: #2980b9; }
    .list-container { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; }
    .list-container h4 { margin-bottom: 15px; color: #2c3e50; }
    .participant-item, .mic-request-item { display: flex; justify-content: space-between; align-items: center;
      padding: 10px; border-bottom: 1px solid #eee; }
    .participant-item:last-child, .mic-request-item:last-child { border-bottom: none; }
    .participant-item button, .mic-request-item button { margin-left: 5px; padding: 5px 10px; font-size: 12px;
      border-radius: 3px; border: none; cursor: pointer; color: white; }
    .btn-approve { background: #2ecc71; }
    .btn-reject { background: #e74c3c; }
    .btn-mute { background: #f39c12; }
    .btn-remove { background: #e74c3c; }
    .events-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .event-card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .event-card:hover { transform: translateY(-5px); }
    .event-card h3 { color: #2c3e50; margin-bottom: 10px; }
    .event-card p { color: #7f8c8d; margin-bottom: 10px; }
    .event-card .event-date { color: #e74c3c; font-weight: bold; }
    .countdown { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-top: 10px; }
    .mode-selector { display: none; gap: 15px; margin: 20px 0; } /* Only shown in admin panel */
    .mode-btn { padding: 10px 20px; background: #ddd; border: none; border-radius: 5px; cursor: pointer;
      font-weight: 600; transition: background 0.3s; }
    .mode-btn.active { background: #3498db; color: white; }
    @media (max-width: 768px) {
      .nav .container { flex-direction: column; }
      .sidebar ul { flex-direction: column; margin-top: 20px; }
      .sidebar li { margin: 10px 0; }
      .video-container { height: 220px; }
      .video-grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
      .events-container { grid-template-columns: 1fr; }
      .admin-panel { margin: 10px; padding: 15px; }
      .audio-mode { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
    .fade-in { animation: fadeIn 1s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-left: 4px solid #3498db; border-radius: 50%;
      width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .status-online, .status-offline {
      width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px;
    }
    .status-online { background: #2ecc71; }
    .status-offline { background: #e74c3c; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 10000;
      opacity: 0; transition: opacity 0.3s; }
  </style>
</head>
<body>
  <main id="app">
    <header class="nav" role="navigation" aria-label="Main navigation">
      <div class="container">
        <div class="logo">OpenDeSci</div>
        <nav class="sidebar">
          <ul>
            <li><a href="#/home">Home</a></li>
            <li><a href="#/learn">Learn</a></li>
            <li><a href="#/contribute">Contribute</a></li>
            <li><a href="#/fund-build">Fund & Build</a></li>
            <li><a href="#/community">Community</a></li>
            <li><a href="#/future">Future</a></li>
            <li><a href="#/explore">Project Explorer</a></li>
          </ul>
        </nav>
        <div>
          <button class="voice-btn" aria-label="Start voice navigation" title="Voice"><i class="fa fa-microphone"></i></button>
        </div>
      </div>
    </header>
    <section class="hero fade-in" role="banner">
      <h1>Join the DeSci Community</h1>
      <p>Connect with researchers, developers, and enthusiasts to collaborate on DeSci.</p>
      <button class="btn" onclick="window.location.hash='/community'" aria-label="Join the community">Join Now</button>
      <div class="video-container" id="video-container"></div>
      <div id="live-banner" class="live-banner">ðŸ”´ Live Now on <span id="live-platform"></span></div>
      <button class="join-live-btn" id="join-live-btn">Join Live</button>
    </section>
    <section class="card fade-in" id="leaderboard" aria-labelledby="leaderboard-heading">
      <h2 id="leaderboard-heading">Community Leaderboard</h2>
      <p>Meet our top contributors driving DeSci forward.</p>
      <div class="profile-grid">
        <div class="event-card">
          <h3>Top Contributor: Dr. Jane Smith</h3>
          <p>Published 12 research papers on decentralized science</p>
        </div>
        <div class="event-card">
          <h3>Innovator: Alex Johnson</h3>
          <p>Developed novel data sharing protocol</p>
        </div>
      </div>
    </section>
    <section class="card fade-in live-streaming" aria-labelledby="live-streaming-heading">
      <h2 id="live-streaming-heading">Live Events</h2>
      <div id="live-container"></div>
    </section>
    <section class="card fade-in hosted-calls" aria-labelledby="hosted-calls-heading">
      <h2 id="hosted-calls-heading">Hosted Calls</h2>
      <div id="hosted-call-container" class="events-container">
        <div class="event-card">
          <h3>Weekly DeSci Discussion</h3>
          <p class="event-date">Every Thursday, 5 PM UTC</p>
          <p>Join our weekly community call to discuss DeSci developments</p>
        </div>
      </div>
    </section>
    <section class="card fade-in upcoming-events" aria-labelledby="upcoming-events-heading">
      <h2 id="upcoming-events-heading">Upcoming Events</h2>
      <div id="upcoming-events-container" class="events-container"></div>
    </section>
    <section class="card fade-in past-events" aria-labelledby="past-events-heading">
      <h2 id="past-events-heading">Past Events</h2>
      <div id="past-events-container" class="events-container"></div>
    </section>
    <div class="admin-panel" id="admin-panel">
      <h2>Admin Panel</h2>
      <div class="mode-selector" id="admin-mode-selector">
        <button class="mode-btn active" onclick="setMode('video')">Video Mode</button>
        <button class="mode-btn" onclick="setMode('audio')">Audio Mode</button>
      </div>
      <button onclick="scheduleLive()">Schedule Live</button>
      <button onclick="startLive()" id="start-live-btn">Start Live</button>
      <button onclick="endLive()" id="end-live-btn" style="display:none;">End Live</button>
      <button onclick="muteAll()">Mute All</button>
      <button onclick="togglePromoVideo()" id="promo-toggle-btn">Pause Promo</button>
      <div class="list-container">
        <h4>Microphone Requests</h4>
        <div id="mic-requests"></div>
      </div>
      <div class="list-container">
        <h4>Participants</h4>
        <div id="participants"></div>
      </div>
      <button onclick="logoutAdmin()">Logout</button>
    </div>
    <div class="modal" id="password-modal">
      <div class="modal-content">
        <h3>Admin Login</h3>
        <input type="password" id="admin-password" placeholder="Enter password">
        <button onclick="loginAdmin()">Login</button>
        <button onclick="closeModal('password-modal')">Cancel</button>
      </div>
    </div>
    <div class="modal" id="schedule-modal">
      <div class="modal-content">
        <h3>Schedule Live Event</h3>
        <input type="text" id="event-title" placeholder="Title">
        <input type="datetime-local" id="event-time">
        <select id="event-type">
          <option value="video">Video Mode</option>
          <option value="audio">Audio Mode</option>
        </select>
        <textarea id="event-description" placeholder="Description"></textarea>
        <button onclick="saveEvent()">Save</button>
        <button onclick="closeModal('schedule-modal')">Cancel</button>
      </div>
    </div>
  </main>
  <button class="admin-btn" id="admin-btn" title="Admin Login">ðŸ‘¤</button>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Jitsi Meet API -->
  <script src="https://meet.jit.si/external_api.js"></script>
  <script>
    // ===== JS LOGIC =====
    // Firebase config - change to your own!
    const firebaseConfig = {
      apiKey: "AIzaSyCie4lyWxHhnfaRZnKZI4crWHQQ18EjVVo",
      authDomain: "opendesci-community.firebaseapp.com",
      projectId: "opendesci-community",
      storageBucket: "opendesci-community.appspot.com",
      messagingSenderId: "175060392409",
      appId: "1:175060392409:web:d86e37965cefc1961f21c8",
      measurementId: "G-NPY0HT1R1N"
    };
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    let api = null, isAdmin = false, participants = [], micRequests = [], isLive = false, currentMode = 'video', promoPlaying = false, eventsData = [], jitsiRoomName = '';

    // Utility/Modal
    function openPasswordModal() { document.getElementById('password-modal').style.display = 'flex'; document.getElementById('admin-password').value = ''; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
      let toast = document.getElementById('toast');
      if (!toast) { toast = document.createElement('div'); toast.id = 'toast'; document.body.appendChild(toast); }
      toast.textContent = msg; toast.style.opacity = '1';
      setTimeout(() => { toast.style.opacity = '0'; }, 3000);
    }

    // Admin Login/Logout
    async function loginAdmin() {
      const password = document.getElementById('admin-password').value;
      const email = "boberudite47@gmail.com";
      try {
        await firebase.auth().signInWithEmailAndPassword(email, password);
        isAdmin = true;
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-mode-selector').style.display = 'flex';
        closeModal('password-modal');
        localStorage.setItem('adminSession', 'true');
      } catch (error) { alert('Login failed: ' + error.message); }
    }
    function logoutAdmin() {
      firebase.auth().signOut().then(() => {
        isAdmin = false; document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-mode-selector').style.display = 'none';
        localStorage.removeItem('adminSession');
      });
    }

    // Mode Selector (admin only)
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.mode-btn[onclick="setMode(\'video\')"]').classList.toggle('active', mode === 'video');
      document.querySelector('.mode-btn[onclick="setMode(\'audio\')"]').classList.toggle('active', mode === 'audio');
      document.getElementById('video-grid').style.display = (mode === 'video') ? 'grid' : 'none';
      document.getElementById('audio-mode').style.display = (mode === 'audio') ? 'grid' : 'none';
      if (isLive && isAdmin) { endLive(); setTimeout(startLive, 1000); }
    }

    // Promo Video
    function playPromoVideo() {
      const promoVideo = document.getElementById('promo-video');
      const promoControls = document.getElementById('promo-controls');
      if (promoVideo && promoControls) {
        promoVideo.style.display = 'block'; promoControls.style.display = 'flex';
        promoVideo.play(); promoPlaying = true;
      }
    }
    function togglePromoVideo() {
      const promoVideo = document.getElementById('promo-video');
      const promoBtn = document.getElementById('promo-toggle-btn');
      if (promoVideo) {
        if (promoPlaying) { promoVideo.pause(); if (promoBtn) promoBtn.textContent = 'Play Promo'; promoPlaying = false; }
        else { promoVideo.play(); if (promoBtn) promoBtn.textContent = 'Pause Promo'; promoPlaying = true; }
      }
    }

    // Event Scheduling
    function scheduleLive() { document.getElementById('schedule-modal').style.display = 'flex'; }
    async function saveEvent() {
      const title = document.getElementById('event-title').value.trim();
      const time = document.getElementById('event-time').value;
      const type = document.getElementById('event-type').value;
      const description = document.getElementById('event-description').value.trim();
      if (!title || !time) return alert('Please fill in title and time');
      const event = { title, time, type, description, createdAt: new Date().toISOString() };
      eventsData.push(event);
      localStorage.setItem('communityEvents', JSON.stringify(eventsData));
      if (typeof firebase !== 'undefined' && isAdmin) {
        await firebase.firestore().collection('events').add({ ...event, createdBy: firebase.auth().currentUser.uid });
      }
      alert('Event scheduled successfully!');
      closeModal('schedule-modal');
      document.getElementById('event-title').value = '';
      document.getElementById('event-time').value = '';
      document.getElementById('event-description').value = '';
      loadEvents();
    }
    function loadEvents() {
      const storedEvents = localStorage.getItem('communityEvents');
      eventsData = storedEvents ? JSON.parse(storedEvents) : [];
      if (typeof firebase !== 'undefined') {
        firebase.firestore().collection('events').orderBy('time', 'asc').get()
          .then(snapshot => {
            snapshot.forEach(doc => {
              const event = doc.data();
              if (!eventsData.find(e => e.title === event.title && e.time === event.time)) eventsData.push(event);
            });
            renderEvents();
          }).catch(() => renderEvents());
      } else { renderEvents(); }
    }
    function renderEvents() {
      const upcomingContainer = document.getElementById('upcoming-events-container');
      const pastContainer = document.getElementById('past-events-container');
      if (!upcomingContainer || !pastContainer) return;
      upcomingContainer.innerHTML = '';
      pastContainer.innerHTML = '';
      const now = new Date();
      eventsData.forEach(event => {
        const eventDate = new Date(event.time);
        const id = event.title.replace(/\s+/g, '-');
        const eventHTML = `
          <div class="event-card">
            <h3>${event.title}</h3>
            <p class="event-date">${eventDate.toLocaleString()}</p>
            <p>Type: ${event.type}</p>
            <p>${event.description || 'No description'}</p>
            <div class="countdown" id="countdown-${id}"></div>
          </div>
        `;
        if (eventDate > now) {
          upcomingContainer.innerHTML += eventHTML;
          setTimeout(() => setupCountdown(id, eventDate), 100);
        } else {
          pastContainer.innerHTML += eventHTML;
        }
      });
    }
    function setupCountdown(id, eventDate) {
      const countdownElement = document.getElementById(`countdown-${id}`);
      if (!countdownElement) return;
      const countdownInterval = setInterval(() => {
        const now = new Date();
        const distance = eventDate - now;
        if (distance < 0) { clearInterval(countdownInterval); countdownElement.innerHTML = 'Event started!'; return; }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }, 1000);
    }

    // Jitsi Meet (admin only starts)
    function startLive() {
      if (!isAdmin) { showToast('Only admin can start live.'); return; }
      jitsiRoomName = 'OpenDeSci-' + Date.now();
      isLive = true;
      document.getElementById('start-live-btn').style.display = 'none';
      document.getElementById('end-live-btn').style.display = 'inline-block';
      document.getElementById('live-banner').style.display = 'block';
      document.getElementById('live-platform').textContent = 'Jitsi Meet';
      document.getElementById('join-live-btn').style.display = 'inline-block';
      setLiveVideoPlaceholder();
      const promoVideo = document.getElementById('promo-video');
      if (promoVideo) promoVideo.pause();
      // Jitsi API options - NO branding/logos, NO external links
      const domain = 'meet.jit.si';
      const options = {
        roomName: jitsiRoomName,
        width: '100%',
        height: '100%',
        parentNode: document.getElementById('video-container'),
        configOverwrite: {
          startWithAudioMuted: true,
          startWithVideoMuted: currentMode === 'audio',
          enableWelcomePage: false,
          prejoinPageEnabled: false,
          disableDeepLinking: true,
          enableNoisyMicDetection: false,
          requireDisplayName: true,
          enableClosePage: false
        },
        interfaceConfigOverwrite: {
          TOOLBAR_BUTTONS: [],
          SHOW_JITSI_WATERMARK: false,
          SHOW_WATERMARK_FOR_GUESTS: false,
          SHOW_BRAND_WATERMARK: false,
          HIDE_INVITE_MORE_HEADER: true,
          MOBILE_APP_PROMO: false,
          DISPLAY_WELCOME_FOOTER: false,
          DISPLAY_WELCOME_PAGE_CONTENT: false,
          SHOW_POWERED_BY: false,
          SHOW_CHROME_EXTENSION_BANNER: false,
          SHOW_DEEP_LINKING: false,
        },
        userInfo: { displayName: 'Host', email: '' }
      };
      if (typeof JitsiMeetExternalAPI === 'undefined') { showToast('Jitsi Meet API not loaded.'); return; }
      api = new JitsiMeetExternalAPI(domain, options);
      api.addEventListener('participantJoined', handleParticipantJoined);
      api.addEventListener('participantLeft', handleParticipantLeft);
      api.addEventListener('raiseHandUpdated', handleRaiseHandUpdated);
      api.addEventListener('videoConferenceJoined', handleConferenceJoined);
      api.addEventListener('videoConferenceLeft', handleConferenceLeft);
    }
    function joinLiveMeeting() {
      if (!isLive || !jitsiRoomName) { showToast('No live meeting is currently active'); return; }
      // Participants get the full embedded experience (if desired, open in new tab instead)
      window.open(`https://meet.jit.si/${jitsiRoomName}`, '_blank');
    }
    function endLive() {
      if (api) { api.dispose(); api = null; }
      isLive = false;
      document.getElementById('start-live-btn').style.display = 'inline-block';
      document.getElementById('end-live-btn').style.display = 'none';
      document.getElementById('live-banner').style.display = 'none';
      document.getElementById('join-live-btn').style.display = 'none';
      participants = []; micRequests = [];
      updateParticipantsList(); updateMicRequestsList();
      setDefaultVideoPlaceholder();
    }

    // Video Placeholder
    function setDefaultVideoPlaceholder() {
      const videoContainer = document.getElementById('video-container');
      if (videoContainer) {
        videoContainer.innerHTML = `
          <div class="video-grid" id="video-grid"></div>
          <div class="audio-mode" id="audio-mode" style="display: none;"></div>
          <video class="promo-video" id="promo-video" controls>
            <source src="https://assets.codepen.io/3364143/sample.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="promo-controls" id="promo-controls">
            <button class="btn" onclick="togglePromoVideo()">Pause Promo</button>
          </div>
        `;
        playPromoVideo();
      }
    }
    function setLiveVideoPlaceholder() {
      const videoContainer = document.getElementById('video-container');
      if (videoContainer) {
        videoContainer.innerHTML = `
          <div class="video-grid" id="video-grid"></div>
          <div class="audio-mode" id="audio-mode" style="display: none;"></div>
        `;
        setMode(currentMode);
      }
    }

    // Jitsi/Participants Management
    function handleParticipantJoined(event) {
      const participant = { id: event.id, displayName: event.displayName || 'Participant', role: 'listener' };
      if (!participants.find(p => p.id === participant.id)) {
        participants.push(participant); updateParticipantsList();
        renderVideoGrid(); renderAudioMode();
      }
    }
    function handleParticipantLeft(event) {
      participants = participants.filter(p => p.id !== event.id);
      updateParticipantsList(); renderVideoGrid(); renderAudioMode();
      micRequests = micRequests.filter(r => r.participantId !== event.id);
      updateMicRequestsList();
    }
    function handleRaiseHandUpdated(event) {
      if (event.raisedHand) {
        const participant = participants.find(p => p.id === event.participantId);
        if (participant && !micRequests.find(r => r.participantId === event.participantId)) {
          micRequests.push({ participantId: event.participantId, displayName: participant.displayName });
          updateMicRequestsList();
        }
      } else {
        micRequests = micRequests.filter(r => r.participantId !== event.participantId);
        updateMicRequestsList();
      }
    }
    function handleConferenceJoined(event) {}
    function handleConferenceLeft(event) { if (event.reason === 'clicked hangup') endLive(); }
    function renderVideoGrid() {
      const videoGrid = document.getElementById('video-grid'); if (!videoGrid) return;
      videoGrid.innerHTML = '';
      const host = { id: 'host', displayName: 'Host', role: 'host' };
      const allParticipants = [host, ...participants].slice(0, 16);
      allParticipants.forEach(participant => {
        const videoItem = document.createElement('div'); videoItem.className = 'video-item';
        videoItem.innerHTML = `
          <div style="width:100%; height:100%; background:#3498db; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
            ${participant.displayName.charAt(0)}
          </div>
          <div class="name-overlay">${participant.displayName}</div>
        `;
        videoGrid.appendChild(videoItem);
      });
    }
    function renderAudioMode() {
      const audioMode = document.getElementById('audio-mode'); if (!audioMode) return;
      audioMode.innerHTML = '';
      const hostCard = document.createElement('div');
      hostCard.className = 'participant-card host';
      hostCard.innerHTML = `<div class="avatar">H</div><h4>Host</h4><p>Host</p>`;
      audioMode.appendChild(hostCard);
      participants.filter(p => p.role === 'speaker').forEach(participant => {
        const speakerCard = document.createElement('div');
        speakerCard.className = 'participant-card speaker';
        speakerCard.innerHTML = `<div class="avatar">${participant.displayName.charAt(0)}</div><h4>${participant.displayName}</h4><p>Speaker</p>`;
        audioMode.appendChild(speakerCard);
      });
      participants.filter(p => p.role === 'listener').forEach(participant => {
        const listenerCard = document.createElement('div');
        listenerCard.className = 'participant-card';
        listenerCard.innerHTML = `<div class="avatar">${participant.displayName.charAt(0)}</div><h4>${participant.displayName}</h4><p>Listener</p>`;
        audioMode.appendChild(listenerCard);
      });
    }
    function updateParticipantsList() {
      const participantsContainer = document.getElementById('participants'); if (!participantsContainer) return;
      participantsContainer.innerHTML = '';
      if (participants.length === 0) { participantsContainer.innerHTML = '<p>No participants</p>'; return; }
      participants.forEach(participant => {
        const participantEl = document.createElement('div'); participantEl.className = 'participant-item';
        participantEl.innerHTML = `
          <span>${participant.displayName} (${participant.role})</span>
          <div>
            <button class="btn-mute" onclick="muteParticipant('${participant.id}')">Mute</button>
            <button class="btn-remove" onclick="kickParticipant('${participant.id}')">Remove</button>
            ${participant.role === 'listener' ?
              `<button class="btn-approve" onclick="promoteToSpeaker('${participant.id}')">Promote</button>` :
              `<button class="btn-reject" onclick="demoteToListener('${participant.id}')">Demote</button>`
            }
          </div>
        `;
        participantsContainer.appendChild(participantEl);
      });
    }
    function updateMicRequestsList() {
      const micRequestsContainer = document.getElementById('mic-requests'); if (!micRequestsContainer) return;
      micRequestsContainer.innerHTML = '';
      if (micRequests.length === 0) { micRequestsContainer.innerHTML = '<p>No mic requests</p>'; return; }
      micRequests.forEach(request => {
        const requestEl = document.createElement('div'); requestEl.className = 'mic-request-item';
        requestEl.innerHTML = `
          <span>${request.displayName} wants to speak</span>
          <div>
            <button class="btn-approve" onclick="approveMicRequest('${request.participantId}')">Approve</button>
            <button class="btn-reject" onclick="rejectMicRequest('${request.participantId}')">Reject</button>
          </div>
        `;
        micRequestsContainer.appendChild(requestEl);
      });
    }
    function muteAll() { if (!api) return; participants.forEach(participant => api.executeCommand('muteParticipant', participant.id)); }
    function muteParticipant(participantId) { if (api) api.executeCommand('muteParticipant', participantId); }
    function kickParticipant(participantId) { if (api) api.executeCommand('kickParticipant', participantId); }
    function promoteToSpeaker(participantId) {
      const participant = participants.find(p => p.id === participantId);
      if (participant) { participant.role = 'speaker'; updateParticipantsList(); renderAudioMode(); }
    }
    function demoteToListener(participantId) {
      const participant = participants.find(p => p.id === participantId);
      if (participant) { participant.role = 'listener'; updateParticipantsList(); renderAudioMode(); }
    }
    function approveMicRequest(participantId) {
      if (!api) return;
      api.executeCommand('muteParticipant', participantId, false);
      promoteToSpeaker(participantId);
      micRequests = micRequests.filter(r => r.participantId !== participantId);
      updateMicRequestsList();
    }
    function rejectMicRequest(participantId) {
      micRequests = micRequests.filter(r => r.participantId !== participantId);
      updateMicRequestsList();
    }

    // Initialization
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('admin-btn').onclick = openPasswordModal;
      document.getElementById('join-live-btn').onclick = joinLiveMeeting;
      setDefaultVideoPlaceholder(); loadEvents();
      if (localStorage.getItem('adminSession') === 'true') {
        document.getElementById('admin-panel').style.display = 'block'; isAdmin = true;
        document.getElementById('admin-mode-selector').style.display = 'flex';
      }
    });
  </script>
</body>
</html>
